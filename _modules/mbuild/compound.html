

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mbuild.compound &mdash; mbuild 0.7.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="mbuild 0.7.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> mbuild
          

          
          </a>

          
            
            
              <div class="version">
                0.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorials.html">Tutorials</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_structures.html">Data Structure</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../coordinate_transforms.html">Coordinate transformations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">Recipes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">mbuild</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>mbuild.compound</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mbuild.compound</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="s1">&#39;clone&#39;</span><span class="p">,</span> <span class="s1">&#39;Compound&#39;</span><span class="p">,</span> <span class="s1">&#39;Particle&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">oset</span> <span class="k">import</span> <span class="n">oset</span> <span class="k">as</span> <span class="n">OrderedSet</span>
<span class="kn">import</span> <span class="nn">parmed</span> <span class="k">as</span> <span class="nn">pmd</span>
<span class="kn">from</span> <span class="nn">parmed.periodic_table</span> <span class="k">import</span> <span class="n">AtomicNum</span><span class="p">,</span> <span class="n">element_by_name</span><span class="p">,</span> <span class="n">Mass</span>
<span class="kn">import</span> <span class="nn">simtk.openmm.app.element</span> <span class="k">as</span> <span class="nn">elem</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">integer_types</span><span class="p">,</span> <span class="n">string_types</span>

<span class="kn">from</span> <span class="nn">mbuild.bond_graph</span> <span class="k">import</span> <span class="n">BondGraph</span>
<span class="kn">from</span> <span class="nn">mbuild.box</span> <span class="k">import</span> <span class="n">Box</span>
<span class="kn">from</span> <span class="nn">mbuild.coordinate_transform</span> <span class="k">import</span> <span class="n">translate</span>
<span class="kn">from</span> <span class="nn">mbuild.exceptions</span> <span class="k">import</span> <span class="n">MBuildError</span>
<span class="kn">from</span> <span class="nn">mbuild.formats.hoomdxml</span> <span class="k">import</span> <span class="n">write_hoomdxml</span>
<span class="kn">from</span> <span class="nn">mbuild.formats.lammpsdata</span> <span class="k">import</span> <span class="n">write_lammpsdata</span>
<span class="kn">from</span> <span class="nn">mbuild.formats.gsdwriter</span> <span class="k">import</span> <span class="n">write_gsd</span>
<span class="kn">from</span> <span class="nn">mbuild.periodic_kdtree</span> <span class="k">import</span> <span class="n">PeriodicCKDTree</span>
<span class="kn">from</span> <span class="nn">mbuild.utils.io</span> <span class="k">import</span> <span class="n">run_from_ipython</span><span class="p">,</span> <span class="n">import_</span>
<span class="kn">from</span> <span class="nn">mbuild.coordinate_transform</span> <span class="k">import</span> <span class="n">_translate</span><span class="p">,</span> <span class="n">_rotate</span>

<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">relative_to_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">rigid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load a file into an mbuild compound.</span>

<span class="sd">    Files are read using the MDTraj package. Please refer to http://mdtraj.org/</span>
<span class="sd">    1.8.0/load_functions.html for supported formats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file from which to load atom and bond information.</span>
<span class="sd">    relative_to_module : str, optional, default=None</span>
<span class="sd">        Instead of looking in the current working directory, look for the file</span>
<span class="sd">        where this module is defined. This is typically used in Compound classes</span>
<span class="sd">        that will be instantiated from a different directory (such as the</span>
<span class="sd">        Compounds located in mbuild.lib).</span>
<span class="sd">    compound : mb.Compound, optional, default=None</span>
<span class="sd">        Existing compound to load atom and bond information into.</span>
<span class="sd">    coords_only : bool, optional, default=False</span>
<span class="sd">        Only load the coordinates into an existing compoint.</span>
<span class="sd">    rigid : bool, optional</span>
<span class="sd">        Treat the compound as a rigid body</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    compound : mb.Compound</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle mbuild *.py files containing a class that wraps a structure file</span>
    <span class="c1"># in its own folder. E.g., you build a system from ~/foo.py and it imports</span>
    <span class="c1"># from ~/bar/baz.py where baz.py loads ~/bar/baz.pdb.</span>
    <span class="k">if</span> <span class="n">relative_to_module</span><span class="p">:</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">relative_to_module</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">compound</span> <span class="o">=</span> <span class="n">Compound</span><span class="p">()</span>

    <span class="n">traj</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">compound</span><span class="o">.</span><span class="n">from_trajectory</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="n">coords_only</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rigid</span><span class="p">:</span>
        <span class="n">compound</span><span class="o">.</span><span class="n">label_rigid_bodies</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">compound</span>


<span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="n">existing_compound</span><span class="p">,</span> <span class="n">clone_of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_container</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A faster alternative to deepcopying.</span>

<span class="sd">    Does not resolve circular dependencies. This should be safe provided</span>
<span class="sd">    you never try to add the top of a Compound hierarchy to a</span>
<span class="sd">    sub-Compound.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    existing_compound : mb.Compound</span>
<span class="sd">        Existing Compound that will be copied</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    clone_of : dict, optional</span>
<span class="sd">    root_container : mb.Compound, optional</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clone_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clone_of</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">newone</span> <span class="o">=</span> <span class="n">existing_compound</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">clone_of</span><span class="o">=</span><span class="n">clone_of</span><span class="p">,</span>
                                      <span class="n">root_container</span><span class="o">=</span><span class="n">root_container</span><span class="p">)</span>
    <span class="n">existing_compound</span><span class="o">.</span><span class="n">_clone_bonds</span><span class="p">(</span><span class="n">clone_of</span><span class="o">=</span><span class="n">clone_of</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newone</span>


<div class="viewcode-block" id="Compound"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound">[docs]</a><span class="k">class</span> <span class="nc">Compound</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A building block in the mBuild hierarchy.</span>

<span class="sd">    Compound is the superclass of all composite building blocks in the mBuild</span>
<span class="sd">    hierarchy. That is, all composite building blocks must inherit from</span>
<span class="sd">    compound, either directly or indirectly. The design of Compound follows the</span>
<span class="sd">    Composite design pattern (Gamma, Erich; Richard Helm; Ralph Johnson; John</span>
<span class="sd">    M. Vlissides (1995). Design Patterns: Elements of Reusable Object-Oriented</span>
<span class="sd">    Software. Addison-Wesley. p. 395. ISBN 0-201-63361-2.), with Compound being</span>
<span class="sd">    the composite, and Particle playing the role of the primitive (leaf) part,</span>
<span class="sd">    where Particle is in fact simply an alias to the Compound class.</span>

<span class="sd">    Compound maintains a list of children (other Compounds contained within),</span>
<span class="sd">    and provides a means to tag the children with labels, so that the compounds</span>
<span class="sd">    can be easily looked up later. Labels may also point to objects outside the</span>
<span class="sd">    Compound&#39;s containment hierarchy. Compound has built-in support for copying</span>
<span class="sd">    and deepcopying Compound hierarchies, enumerating particles or bonds in the</span>
<span class="sd">    hierarchy, proximity based searches, visualization, I/O operations, and a</span>
<span class="sd">    number of other convenience methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subcompounds : mb.Compound or list of mb.Compound, optional, default=None</span>
<span class="sd">        One or more compounds to be added to self.</span>
<span class="sd">    name : str, optional, default=self.__class__.__name__</span>
<span class="sd">        The type of Compound.</span>
<span class="sd">    pos : np.ndarray, shape=(3,), dtype=float, optional, default=[0, 0, 0]</span>
<span class="sd">        The position of the Compound in Cartestian space</span>
<span class="sd">    charge : float, optional, default=0.0</span>
<span class="sd">        Currently not used. Likely removed in next release.</span>
<span class="sd">    periodicity : np.ndarray, shape=(3,), dtype=float, optional, default=[0, 0, 0]</span>
<span class="sd">        The periodic lengths of the Compound in the x, y and z directions.</span>
<span class="sd">        Defaults to zeros which is treated as non-periodic.</span>
<span class="sd">    port_particle : bool, optional, default=False</span>
<span class="sd">        Whether or not this Compound is part of a Port</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    bond_graph : mb.BondGraph</span>
<span class="sd">        Graph-like object that stores bond information for this Compound</span>
<span class="sd">    children : OrderedSet</span>
<span class="sd">        Contains all children (other Compounds).</span>
<span class="sd">    labels : OrderedDict</span>
<span class="sd">        Labels to Compound/Atom mappings. These do not necessarily need not be</span>
<span class="sd">        in self.children.</span>
<span class="sd">    parent : mb.Compound</span>
<span class="sd">        The parent Compound that contains this part. Can be None if this</span>
<span class="sd">        compound is the root of the containment hierarchy.</span>
<span class="sd">    referrers : set</span>
<span class="sd">        Other compounds that reference this part with labels.</span>
<span class="sd">    rigid_id : int, default=None</span>
<span class="sd">        The ID of the rigid body that this Compound belongs to.  Only Particles</span>
<span class="sd">        (the bottom of the containment hierarchy) can have integer values for</span>
<span class="sd">        `rigid_id`. Compounds containing rigid particles will always have </span>
<span class="sd">        `rigid_id == None`. See also `contains_rigid`.</span>
<span class="sd">    boundingbox</span>
<span class="sd">    center</span>
<span class="sd">    contains_rigid</span>
<span class="sd">    max_rigid_id</span>
<span class="sd">    n_particles</span>
<span class="sd">    n_bonds</span>
<span class="sd">    root</span>
<span class="sd">    xyz</span>
<span class="sd">    xyz_with_ports</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcompounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">periodicity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">port_particle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Compound</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Compound.name should be a string. You passed &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># A periodicity of zero in any direction is treated as non-periodic.</span>
        <span class="k">if</span> <span class="n">periodicity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">periodicity</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">referrers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bond_graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_particle</span> <span class="o">=</span> <span class="n">port_particle</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rigid_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contains_rigid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># self.add() must be called after labels and children are initialized.</span>
        <span class="k">if</span> <span class="n">subcompounds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subcompounds</span><span class="p">)</span>

<div class="viewcode-block" id="Compound.particles"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.particles">[docs]</a>    <span class="k">def</span> <span class="nf">particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Particles of the Compound.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        include_ports : bool, optional, default=False</span>
<span class="sd">            Include port particles</span>

<span class="sd">        Yields</span>
<span class="sd">        -------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The next Particle in the Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">particle</span></div>

    <span class="k">def</span> <span class="nf">_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Particles of the Compound. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">include_ports</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">port_particle</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">child</span>

<div class="viewcode-block" id="Compound.successors"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.successors">[docs]</a>    <span class="k">def</span> <span class="nf">successors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield Compounds below self in the hierarchy.</span>

<span class="sd">        Yields</span>
<span class="sd">        -------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The next Particle below self in the hierarchy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="c1"># Parts local to the current Compound.</span>
            <span class="k">yield</span> <span class="n">part</span>
            <span class="c1"># Parts further down the hierarchy.</span>
            <span class="k">for</span> <span class="n">subpart</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">successors</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">subpart</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of Particles in the Compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of Particles in the Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_n_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of Particles in the Compound. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_contains_only_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="o">.</span><span class="n">port_particle</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Compound.ancestors"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.ancestors">[docs]</a>    <span class="k">def</span> <span class="nf">ancestors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate all ancestors of the Compound recursively.</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The next Compound above self in the hierarchy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">ancestor</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Compound at the top of self&#39;s hierarchy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The Compound at the top of self&#39;s hierarchy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">parent</span>

<div class="viewcode-block" id="Compound.particles_by_name"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.particles_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">particles_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Particles of the Compound with a specific name</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Only particles with this name are returned</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The next Particle in the Compound with the user-specified name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">particle</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rigid_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rigid_id</span>

    <span class="nd">@rigid_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rigid_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_only_ports</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rigid_id</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                <span class="n">ancestor</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;rigid_id is immutable for Compounds that are &quot;</span>
                                 <span class="s2">&quot;not at the bottom of the containment hierarchy.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contains_rigid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if the Compound contains rigid bodies</span>

<span class="sd">        If the Compound contains any particle with a rigid_id != None </span>
<span class="sd">        then contains_rigid will return True. If the Compound has no</span>
<span class="sd">        children (i.e. the Compound resides at the bottom of the containment</span>
<span class="sd">        hierarchy) then contains_rigid will return False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the Compound contains any particle with a rigid_id != None</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The private variable &#39;_check_if_contains_rigid_bodies&#39; is used to help</span>
<span class="sd">        cache the status of &#39;contains_rigid&#39;. If &#39;_check_if_contains_rigid_bodies&#39;</span>
<span class="sd">        is False, then the rigid body containment of the Compound has not changed,</span>
<span class="sd">        and the particle tree is not traversed, boosting performance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_contains_rigid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_contains_rigid</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_rigid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_rigid_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the maximum rigid body ID contained in the Compound.</span>

<span class="sd">        This is usually used by compound.root to determine the maximum</span>
<span class="sd">        rigid_id in the containment hierarchy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or None</span>
<span class="sd">            The maximum rigid body ID contained in the Compound. If no</span>
<span class="sd">            rigid body IDs are found, None is returned</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">([</span><span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span>

<div class="viewcode-block" id="Compound.rigid_particles"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.rigid_particles">[docs]</a>    <span class="k">def</span> <span class="nf">rigid_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rigid_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate all particles in rigid bodies.</span>

<span class="sd">        If a rigid_id is specified, then this function will only yield particles</span>
<span class="sd">        with a matching rigid_id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rigid_id : int, optional</span>
<span class="sd">            Include only particles with this rigid body ID</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        mb.Compound</span>
<span class="sd">            The next particle with a rigid_id that is not None, or the next</span>
<span class="sd">            particle with a matching rigid_id if specified</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">==</span> <span class="n">rigid_id</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">particle</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">particle</span></div>

<div class="viewcode-block" id="Compound.label_rigid_bodies"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.label_rigid_bodies">[docs]</a>    <span class="k">def</span> <span class="nf">label_rigid_bodies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discrete_bodies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rigid_particles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Designate which Compounds should be treated as rigid bodies</span>

<span class="sd">        If no arguments are provided, this function will treat the compound</span>
<span class="sd">        as a single rigid body by providing all particles in `self` with the</span>
<span class="sd">        same rigid_id. If `discrete_bodies` is not None, each instance of </span>
<span class="sd">        a Compound with a name found in `discrete_bodies` will be treated as a </span>
<span class="sd">        unique rigid body. If `rigid_particles` is not None, only Particles </span>
<span class="sd">        (Compounds at the bottom of the containment hierarchy) matching this name </span>
<span class="sd">        will be considered part of the rigid body.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        discrete_bodies : str or list of str, optional, default=None</span>
<span class="sd">            Name(s) of Compound instances to be treated as unique rigid bodies.</span>
<span class="sd">            Compound instances matching this (these) name(s) will be provided </span>
<span class="sd">            with unique rigid_ids</span>
<span class="sd">        rigid_particles : str or list of str, optional, default=None</span>
<span class="sd">            Name(s) of Compound instances at the bottom of the containment</span>
<span class="sd">            hierarchy (Particles) to be included in rigid bodies. Only Particles</span>
<span class="sd">            matching this (these) name(s) will have their rigid_ids altered to </span>
<span class="sd">            match the rigid body number.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Creating a rigid benzene</span>

<span class="sd">        &gt;&gt;&gt; import mbuild as mb</span>
<span class="sd">        &gt;&gt;&gt; from mbuild.utils.io import get_fn</span>
<span class="sd">        &gt;&gt;&gt; benzene = mb.load(get_fn(&#39;benzene.mol2&#39;))</span>
<span class="sd">        &gt;&gt;&gt; benzene.label_rigid_bodies()</span>

<span class="sd">        Creating a semi-rigid benzene, where only the carbons are treated as</span>
<span class="sd">        a rigid body</span>

<span class="sd">        &gt;&gt;&gt; import mbuild as mb</span>
<span class="sd">        &gt;&gt;&gt; from mbuild.utils.io import get_fn</span>
<span class="sd">        &gt;&gt;&gt; benzene = mb.load(get_fn(&#39;benzene.mol2&#39;))</span>
<span class="sd">        &gt;&gt;&gt; benzene.label_rigid_bodies(rigid_particles=&#39;C&#39;)</span>

<span class="sd">        Create a box of rigid benzenes, where each benzene has a unique rigid</span>
<span class="sd">        body ID.</span>

<span class="sd">        &gt;&gt;&gt; import mbuild as mb</span>
<span class="sd">        &gt;&gt;&gt; from mbuild.utils.io import get_fn</span>
<span class="sd">        &gt;&gt;&gt; benzene = mb.load(get_fn(&#39;benzene.mol2&#39;))</span>
<span class="sd">        &gt;&gt;&gt; benzene.name = &#39;Benzene&#39;</span>
<span class="sd">        &gt;&gt;&gt; filled = mb.fill_box(benzene,</span>
<span class="sd">        ...                      n_compounds=10,</span>
<span class="sd">        ...                      box=[0, 0, 0, 4, 4, 4])</span>
<span class="sd">        &gt;&gt;&gt; filled.label_rigid_bodies(distinct_bodies=&#39;Benzene&#39;)</span>

<span class="sd">        Create a box of semi-rigid benzenes, where each benzene has a unique</span>
<span class="sd">        rigid body ID and only the carbon portion is treated as rigid.</span>

<span class="sd">        &gt;&gt;&gt; import mbuild as mb</span>
<span class="sd">        &gt;&gt;&gt; from mbuild.utils.io import get_fn</span>
<span class="sd">        &gt;&gt;&gt; benzene = mb.load(get_fn(&#39;benzene.mol2&#39;))</span>
<span class="sd">        &gt;&gt;&gt; benzene.name = &#39;Benzene&#39;</span>
<span class="sd">        &gt;&gt;&gt; filled = mb.fill_box(benzene,</span>
<span class="sd">        ...                      n_compounds=10,</span>
<span class="sd">        ...                      box=[0, 0, 0, 4, 4, 4])</span>
<span class="sd">        &gt;&gt;&gt; filled.label_rigid_bodies(distinct_bodies=&#39;Benzene&#39;,</span>
<span class="sd">        ...                           rigid_particles=&#39;C&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">discrete_bodies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discrete_bodies</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">discrete_bodies</span> <span class="o">=</span> <span class="p">[</span><span class="n">discrete_bodies</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rigid_particles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rigid_particles</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">rigid_particles</span> <span class="o">=</span> <span class="p">[</span><span class="n">rigid_particles</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">max_rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rigid_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">max_rigid_id</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> rigid bodies already exist.  Incrementing &#39;rigid_id&#39;&quot;</span>
                 <span class="s2">&quot;starting from </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rigid_id</span><span class="p">,</span> <span class="n">rigid_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rigid_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">discrete_bodies</span> <span class="ow">and</span> <span class="n">successor</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discrete_bodies</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">successor</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rigid_particles</span> <span class="ow">and</span> <span class="n">particle</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rigid_particles</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">=</span> <span class="n">rigid_id</span>
            <span class="k">if</span> <span class="n">discrete_bodies</span><span class="p">:</span>
                <span class="n">rigid_id</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Compound.unlabel_rigid_bodies"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.unlabel_rigid_bodies">[docs]</a>    <span class="k">def</span> <span class="nf">unlabel_rigid_bodies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all rigid body labels from the Compound &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_increment_rigid_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment the rigid_id of all rigid Particles in a Compound</span>

<span class="sd">        Adds `increment` to the rigid_id of all Particles in `self` that</span>
<span class="sd">        already have an integer rigid_id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">+=</span> <span class="n">increment</span>

    <span class="k">def</span> <span class="nf">_reorder_rigid_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reorder rigid body IDs ensuring consecutiveness.</span>

<span class="sd">        Primarily used internally to ensure consecutive rigid_ids following </span>
<span class="sd">        removal of a Compound.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_rigid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_rigid_id</span>
        <span class="n">unique_rigid_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">rigid_id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_particles</span><span class="p">()]))</span>
        <span class="n">n_unique_rigid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_rigid</span> <span class="ow">and</span> <span class="n">n_unique_rigid</span> <span class="o">!=</span> <span class="n">max_rigid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">missing_rigid_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">successor</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">successor</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">&gt;</span> <span class="n">missing_rigid_id</span><span class="p">:</span>
                        <span class="n">successor</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">&gt;</span> <span class="n">missing_rigid_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">-=</span> <span class="mi">1</span>

<div class="viewcode-block" id="Compound.add"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_child</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">containment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">inherit_periodicity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_rigid_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a part to the Compound.</span>

<span class="sd">        Note:</span>
<span class="sd">            This does not necessarily add the part to self.children but may</span>
<span class="sd">            instead be used to add a reference to the part to self.labels. See</span>
<span class="sd">            &#39;containment&#39; argument.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_child : mb.Compound or list-like of mb.Compound</span>
<span class="sd">            The object(s) to be added to this Compound.</span>
<span class="sd">        label : str, optional</span>
<span class="sd">            A descriptive string for the part.</span>
<span class="sd">        containment : bool, optional, default=True</span>
<span class="sd">            Add the part to self.children.</span>
<span class="sd">        replace : bool, optional, default=True</span>
<span class="sd">            Replace the label if it already exists.</span>
<span class="sd">        inherit_periodicity : bool, optional, default=True</span>
<span class="sd">            Replace the periodicity of self with the periodicity of the</span>
<span class="sd">            Compound being added</span>
<span class="sd">        reset_rigid_ids : bool, optional, default=True</span>
<span class="sd">            If the Compound to be added contains rigid bodies, reset the </span>
<span class="sd">            rigid_ids such that values remain distinct from rigid_ids</span>
<span class="sd">            already present in `self`. Can be set to False if attempting</span>
<span class="sd">            to add Compounds to an existing rigid body.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Support batch add via lists, tuples and sets.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">new_child</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_child</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">new_child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">reset_rigid_ids</span><span class="o">=</span><span class="n">reset_rigid_ids</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_child</span><span class="p">,</span> <span class="n">Compound</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only objects that inherit from mbuild.Compound &#39;</span>
                             <span class="s1">&#39;can be added to Compounds. You tried to add &#39;</span>
                             <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_child</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">new_child</span><span class="o">.</span><span class="n">contains_rigid</span> <span class="ow">or</span> <span class="n">new_child</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_rigid</span> <span class="ow">and</span> <span class="n">reset_rigid_ids</span><span class="p">:</span>
                <span class="n">new_child</span><span class="o">.</span><span class="n">_increment_rigid_ids</span><span class="p">(</span><span class="n">increment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_rigid_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rigid_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create children and labels on the first add operation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">containment</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_child</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s1">&#39;Part </span><span class="si">{}</span><span class="s1"> already has a parent: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">new_child</span><span class="p">,</span> <span class="n">new_child</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_child</span><span class="p">)</span>
            <span class="n">new_child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>

            <span class="k">if</span> <span class="n">new_child</span><span class="o">.</span><span class="n">bond_graph</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="o">=</span> <span class="n">new_child</span><span class="o">.</span><span class="n">bond_graph</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">new_child</span><span class="o">.</span><span class="n">bond_graph</span><span class="p">)</span>

                <span class="n">new_child</span><span class="o">.</span><span class="n">bond_graph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Add new_part to labels. Does not currently support batch add.</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">[$]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_child</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;[$]&#39;</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label_pattern</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_child</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label_pattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">replace</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s1">&#39;Label &quot;</span><span class="si">{0}</span><span class="s1">&quot; already exists in </span><span class="si">{1}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_child</span>
        <span class="n">new_child</span><span class="o">.</span><span class="n">referrers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">inherit_periodicity</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_child</span><span class="p">,</span> <span class="n">Compound</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">new_child</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">new_child</span><span class="o">.</span><span class="n">periodicity</span></div>

<div class="viewcode-block" id="Compound.remove"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs_to_remove</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove children from the Compound.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objs_to_remove : mb.Compound or list of mb.Compound</span>
<span class="sd">            The Compound(s) to be removed from self</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">objs_to_remove</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">objs_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">objs_to_remove</span><span class="p">]</span>
        <span class="n">objs_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">objs_to_remove</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs_to_remove</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">remove_from_here</span> <span class="o">=</span> <span class="n">objs_to_remove</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">-=</span> <span class="n">remove_from_here</span>
        <span class="n">yet_to_remove</span> <span class="o">=</span> <span class="n">objs_to_remove</span> <span class="o">-</span> <span class="n">remove_from_here</span>

        <span class="k">for</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">remove_from_here</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">removed</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">removed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">removed_part</span> <span class="ow">in</span> <span class="n">remove_from_here</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">removed_part</span><span class="o">.</span><span class="n">rigid_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">removed_part</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                    <span class="n">ancestor</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">removed_part</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">removed_part</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_references</span><span class="p">(</span><span class="n">removed_part</span><span class="p">)</span>

        <span class="c1"># Remove the part recursively from sub-compounds.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">yet_to_remove</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">contains_rigid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">_reorder_rigid_ids</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_remove_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">removed_part</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove labels pointing to this part and vice versa. &quot;&quot;&quot;</span>
        <span class="n">removed_part</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Remove labels in the hierarchy pointing to this part.</span>
        <span class="n">referrers_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">referrer</span> <span class="ow">in</span> <span class="n">removed_part</span><span class="o">.</span><span class="n">referrers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">removed_part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">referrer</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">referred_part</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">referrer</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">referred_part</span> <span class="ow">is</span> <span class="n">removed_part</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">referrer</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                        <span class="n">referrers_to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">referrer</span><span class="p">)</span>
        <span class="n">removed_part</span><span class="o">.</span><span class="n">referrers</span> <span class="o">-=</span> <span class="n">referrers_to_remove</span>

        <span class="c1"># Remove labels in this part pointing into the hierarchy.</span>
        <span class="n">labels_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">removed_part</span><span class="p">,</span> <span class="n">Compound</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">removed_part</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">Compound</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_references</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">removed_part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">part</span><span class="o">.</span><span class="n">referrers</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">removed_part</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">labels_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_to_delete</span><span class="p">:</span>
            <span class="n">removed_part</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="Compound.referenced_ports"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.referenced_ports">[docs]</a>    <span class="k">def</span> <span class="nf">referenced_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Ports referenced by this Compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of mb.Compound</span>
<span class="sd">            A list of all ports referenced by the Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mbuild.port</span> <span class="k">import</span> <span class="n">Port</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">Port</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Compound.all_ports"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.all_ports">[docs]</a>    <span class="k">def</span> <span class="nf">all_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all Ports referenced by this Compound and its successors</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of mb.Compound</span>
<span class="sd">            A list of all Ports referenced by this Compound and its successors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mbuild.port</span> <span class="k">import</span> <span class="n">Port</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">successor</span> <span class="k">for</span> <span class="n">successor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successors</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">successor</span><span class="p">,</span> <span class="n">Port</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Compound.available_ports"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.available_ports">[docs]</a>    <span class="k">def</span> <span class="nf">available_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all unoccupied Ports referenced by this Compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of mb.Compound</span>
<span class="sd">            A list of all unoccupied ports referenced by the Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mbuild.port</span> <span class="k">import</span> <span class="n">Port</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">port</span> <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">Port</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">port</span><span class="o">.</span><span class="n">used</span><span class="p">]</span></div>

<div class="viewcode-block" id="Compound.bonds"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.bonds">[docs]</a>    <span class="k">def</span> <span class="nf">bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all bonds in the Compound and sub-Compounds.</span>

<span class="sd">        Yields</span>
<span class="sd">        -------</span>
<span class="sd">        tuple of mb.Compound</span>
<span class="sd">            The next bond in the Compound</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        bond_graph.edges_iter : Iterates over all edges in a BondGraph</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">())</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">(())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of bonds in the Compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of bonds in the Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">())</span>

<div class="viewcode-block" id="Compound.add_bond"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.add_bond">[docs]</a>    <span class="k">def</span> <span class="nf">add_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_pair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a bond between two Particles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        particle_pair : indexable object, length=2, dtype=mb.Compound</span>
<span class="sd">            The pair of Particles to add a bond between</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="o">=</span> <span class="n">BondGraph</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">particle_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">particle_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Compound.generate_bonds"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.generate_bonds">[docs]</a>    <span class="k">def</span> <span class="nf">generate_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_a</span><span class="p">,</span> <span class="n">name_b</span><span class="p">,</span> <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Bonds between all pairs of types a/b within [dmin, dmax].</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name_a : str</span>
<span class="sd">            The name of one of the Particles to be in each bond</span>
<span class="sd">        name_b : str</span>
<span class="sd">            The name of the other Particle to be in each bond</span>
<span class="sd">        dmin : float</span>
<span class="sd">            The minimum distance between Particles for considering a bond</span>
<span class="sd">        dmax : float</span>
<span class="sd">            The maximum distance between Particles for considering a bond</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">particle_kdtree</span> <span class="o">=</span> <span class="n">PeriodicCKDTree</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">)</span>
        <span class="n">particle_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()))</span>
        <span class="n">added_bonds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles_by_name</span><span class="p">(</span><span class="n">name_a</span><span class="p">):</span>
            <span class="n">nearest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles_in_range</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">max_particles</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                              <span class="n">particle_kdtree</span><span class="o">=</span><span class="n">particle_kdtree</span><span class="p">,</span>
                                              <span class="n">particle_array</span><span class="o">=</span><span class="n">particle_array</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">nearest</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p2</span> <span class="o">==</span> <span class="n">p1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">bond_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">id</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bond_tuple</span> <span class="ow">in</span> <span class="n">added_bonds</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_periodic_distance</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">p1</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name_b</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dmin</span> <span class="o">&lt;=</span> <span class="n">min_dist</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_bond</span><span class="p">((</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>
                    <span class="n">added_bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond_tuple</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compound.remove_bond"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.remove_bond">[docs]</a>    <span class="k">def</span> <span class="nf">remove_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_pair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes a bond between a pair of Particles</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        particle_pair : indexable object, length=2, dtype=mb.Compound</span>
<span class="sd">            The pair of Particles to remove the bond between</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="o">*</span><span class="n">particle_pair</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Bond between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> doesn&#39;t exist!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">particle_pair</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="o">*</span><span class="n">particle_pair</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>

    <span class="nd">@pos</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s1">&#39;Cannot set position on a Compound that has&#39;</span>
                              <span class="s1">&#39; children.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">periodicity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span>

    <span class="nd">@periodicity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">periodicity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_periodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">periods</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all particle coordinates in this compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pos : np.ndarray, shape=(n, 3), dtype=float</span>
<span class="sd">            Array with the positions of all particles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz_with_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all particle coordinates in this compound including ports.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pos : np.ndarray, shape=(n, 3), dtype=float</span>
<span class="sd">            Array with the positions of all particles and ports.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pos</span>

    <span class="nd">@xyz</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrnx3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the positions of the particles in the Compound, excluding the Ports.</span>

<span class="sd">        This function does not set the position of the ports.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arrnx3 : np.ndarray, shape=(n,3), dtype=float</span>
<span class="sd">            The new particle positions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arrnx3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Trying to set position of </span><span class="si">{}</span><span class="s1"> with more than one&#39;</span>
                                 <span class="s1">&#39;coordinate: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrnx3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">arrnx3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">arrnx3</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="nd">@xyz_with_ports</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">xyz_with_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrnx3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the positions of the particles in the Compound, including the Ports.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arrnx3 : np.ndarray, shape=(n,3), dtype=float</span>
<span class="sd">            The new particle positions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arrnx3</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Trying to set position of </span><span class="si">{}</span><span class="s1"> with more than one&#39;</span>
                                 <span class="s1">&#39;coordinate: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrnx3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">arrnx3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">arrnx3</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">coords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The cartesian center of the Compound based on its Particles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray, shape=(3,), dtype=float</span>
<span class="sd">            The cartesian center of the Compound based on its Particles</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">boundingbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the bounding box of the compound.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mb.Box</span>
<span class="sd">            The bounding box for this Compound</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="k">return</span> <span class="n">Box</span><span class="p">(</span><span class="n">mins</span><span class="o">=</span><span class="n">xyz</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">maxs</span><span class="o">=</span><span class="n">xyz</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<div class="viewcode-block" id="Compound.min_periodic_distance"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.min_periodic_distance">[docs]</a>    <span class="k">def</span> <span class="nf">min_periodic_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz0</span><span class="p">,</span> <span class="n">xyz1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vectorized distance calculation considering minimum image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xyz0 : np.ndarray, shape=(3,), dtype=float</span>
<span class="sd">            Coordinates of first point</span>
<span class="sd">        xyz1 : np.ndarray, shape=(3,), dtype=float</span>
<span class="sd">            Coordinates of second point</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Vectorized distance between the two points following minimum</span>
<span class="sd">            image convention</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xyz0</span> <span class="o">-</span> <span class="n">xyz1</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">d</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="Compound.particles_in_range"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.particles_in_range">[docs]</a>    <span class="k">def</span> <span class="nf">particles_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">max_particles</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">particle_kdtree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">particle_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find particles within a specified range of another particle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        compound : mb.Compound</span>
<span class="sd">            Reference particle to find other particles in range of</span>
<span class="sd">        dmax : float</span>
<span class="sd">            Maximum distance from &#39;compound&#39; to look for Particles</span>
<span class="sd">        max_particles : int, optional, default=20</span>
<span class="sd">            Maximum number of Particles to return</span>
<span class="sd">        particle_kdtree : mb.PeriodicCKDTree, optional</span>
<span class="sd">            KD-tree for looking up nearest neighbors. If not provided, a KD-</span>
<span class="sd">            tree will be generated from all Particles in self</span>
<span class="sd">        particle_array : np.ndarray, shape=(n,), dtype=mb.Compound, optional</span>
<span class="sd">            Array of possible particles to consider for return. If not</span>
<span class="sd">            provided, this defaults to all Particles in self</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray, shape=(n,), dtype=mb.Compound</span>
<span class="sd">            Particles in range of compound according to user-defined limits</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        periodic_kdtree.PerioidicCKDTree : mBuild implementation of kd-trees</span>
<span class="sd">        scipy.spatial.ckdtree : Further details on kd-trees</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">particle_kdtree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particle_kdtree</span> <span class="o">=</span> <span class="n">PeriodicCKDTree</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">particle_kdtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">compound</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">max_particles</span><span class="p">,</span> <span class="n">distance_upper_bound</span><span class="o">=</span><span class="n">dmax</span><span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">idxs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">particle_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">particle_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">particle_array</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span></div>

<div class="viewcode-block" id="Compound.visualize"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.visualize">[docs]</a>    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize the Compound using nglview.</span>

<span class="sd">        Allows for visualization of a Compound within a Jupyter Notebook.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_ports : bool, optional, default=False</span>
<span class="sd">            Visualize Ports in addition to Particles</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nglview</span> <span class="o">=</span> <span class="n">import_</span><span class="p">(</span><span class="s1">&#39;nglview&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run_from_ipython</span><span class="p">():</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_trajectory</span><span class="p">(</span><span class="n">show_ports</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nglview</span><span class="o">.</span><span class="n">show_mdtraj</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Visualization is only supported in Jupyter &#39;</span>
                               <span class="s1">&#39;Notebooks.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compound.update_coordinates"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.update_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">update_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">update_port_locations</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the coordinates of this Compound from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of file from which to load coordinates. Supported file types</span>
<span class="sd">            are the same as those supported by load()</span>
<span class="sd">        update_port_locations : bool, optional, default=True</span>
<span class="sd">            Update the locations of Ports so that they are shifted along with</span>
<span class="sd">            their anchor particles.  Note: This conserves the location of</span>
<span class="sd">            Ports with respect to the anchor Particle, but does not conserve</span>
<span class="sd">            the orientation of Ports with respect to the molecule as a whole.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        load : Load coordinates from a file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_port_locations</span><span class="p">:</span>
            <span class="n">xyz_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
            <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">compound</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_port_locations</span><span class="p">(</span><span class="n">xyz_init</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">compound</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_port_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adjust port locations after particles have moved</span>

<span class="sd">        Compares the locations of Particles between &#39;self&#39; and an array of</span>
<span class="sd">        reference coordinates.  Shifts Ports in accordance with how far anchors </span>
<span class="sd">        have been moved.  This conserves the location of Ports with respect to </span>
<span class="sd">        their anchor Particles, but does not conserve the orientation of Ports </span>
<span class="sd">        with respect to the molecule as a whole.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initial_coordinates : np.ndarray, shape=(n, 3), dtype=float</span>
<span class="sd">            Reference coordinates to use for comparing how far anchor Particles</span>
<span class="sd">            have shifted.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ports</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">anchor</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">particles</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">anchor</span><span class="p">)</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">initial_coordinates</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">port</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_kick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Slightly adjust all coordinates in a Compound</span>

<span class="sd">        Provides a slight adjustment to coordinates to kick them out of local </span>
<span class="sd">        energy minima.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xyz_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_port_locations</span><span class="p">(</span><span class="n">xyz_init</span><span class="p">)</span>

<div class="viewcode-block" id="Compound.energy_minimization"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.energy_minimization">[docs]</a>    <span class="k">def</span> <span class="nf">energy_minimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;cg&#39;</span><span class="p">,</span>
                            <span class="n">forcefield</span><span class="o">=</span><span class="s1">&#39;UFF&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform an energy minimization on a Compound</span>

<span class="sd">        Utilizes Open Babel (http://openbabel.org/docs/dev/) to perform an</span>
<span class="sd">        energy minimization/geometry optimization on a Compound by applying</span>
<span class="sd">        a generic force field.</span>

<span class="sd">        This function is primarily intended to be used on smaller components,</span>
<span class="sd">        with sizes on the order of 10&#39;s to 100&#39;s of particles, as the energy</span>
<span class="sd">        minimization scales poorly with the number of particles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        steps : int, optionl, default=1000</span>
<span class="sd">            The number of optimization iterations</span>
<span class="sd">        algorithm : str, optional, default=&#39;cg&#39;</span>
<span class="sd">            The energy minimization algorithm.  Valid options are &#39;steep&#39;, </span>
<span class="sd">            &#39;cg&#39;, and &#39;md&#39;, corresponding to steepest descent, conjugate</span>
<span class="sd">            gradient, and equilibrium molecular dynamics respectively.</span>
<span class="sd">        forcefield : str, optional, default=&#39;UFF&#39;</span>
<span class="sd">            The generic force field to apply to the Compound for minimization.</span>
<span class="sd">            Valid options are &#39;MMFF94&#39;, &#39;MMFF94s&#39;, &#39;&#39;UFF&#39;, &#39;GAFF&#39;, and &#39;Ghemical&#39;.</span>
<span class="sd">            Please refer to the Open Babel documentation (http://open-babel.</span>
<span class="sd">            readthedocs.io/en/latest/Forcefields/Overview.html) when considering </span>
<span class="sd">            your choice of force field.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] O&#39;Boyle, N.M.; Banck, M.; James, C.A.; Morley, C.; </span>
<span class="sd">               Vandermeersch, T.; Hutchison, G.R. &quot;Open Babel: An open</span>
<span class="sd">               chemical toolbox.&quot; (2011) J. Cheminf. 3, 33</span>
<span class="sd">        .. [2] Open Babel, version X.X.X http://openbabel.org, (installed</span>
<span class="sd">               Month Year)</span>

<span class="sd">        If using the &#39;MMFF94&#39; force field please also cite the following:</span>
<span class="sd">        .. [3] T.A. Halgren, &quot;Merck molecular force field. I. Basis, form,</span>
<span class="sd">               scope, parameterization, and performance of MMFF94.&quot; (1996)</span>
<span class="sd">               J. Comput. Chem. 17, 490-519</span>
<span class="sd">        .. [4] T.A. Halgren, &quot;Merck molecular force field. II. MMFF94 van der</span>
<span class="sd">               Waals and electrostatic parameters for intermolecular</span>
<span class="sd">               interactions.&quot; (1996) J. Comput. Chem. 17, 520-552</span>
<span class="sd">        .. [5] T.A. Halgren, &quot;Merck molecular force field. III. Molecular</span>
<span class="sd">               geometries and vibrational frequencies for MMFF94.&quot; (1996)</span>
<span class="sd">               J. Comput. Chem. 17, 553-586</span>
<span class="sd">        .. [6] T.A. Halgren and R.B. Nachbar, &quot;Merck molecular force field.</span>
<span class="sd">               IV. Conformational energies and geometries for MMFF94.&quot; (1996)</span>
<span class="sd">               J. Comput. Chem. 17, 587-615</span>
<span class="sd">        .. [7] T.A. Halgren, &quot;Merck molecular force field. V. Extension of</span>
<span class="sd">               MMFF94 using experimental data, additional computational data,</span>
<span class="sd">               and empirical rules.&quot; (1996) J. Comput. Chem. 17, 616-641</span>

<span class="sd">        If using the &#39;MMFF94s&#39; force field please cite the above along with:</span>
<span class="sd">        .. [8] T.A. Halgren, &quot;MMFF VI. MMFF94s option for energy minimization</span>
<span class="sd">               studies.&quot; (1999) J. Comput. Chem. 20, 720-729</span>

<span class="sd">        If using the &#39;UFF&#39; force field please cite the following:</span>
<span class="sd">        .. [3] Rappe, A.K., Casewit, C.J., Colwell, K.S., Goddard, W.A. III,</span>
<span class="sd">               Skiff, W.M. &quot;UFF, a full periodic table force field for</span>
<span class="sd">               molecular mechanics and molecular dynamics simulations.&quot; (1992)</span>
<span class="sd">               J. Am. Chem. Soc. 114, 10024-10039</span>

<span class="sd">        If using the &#39;GAFF&#39; force field please cite the following:</span>
<span class="sd">        .. [3] Wang, J., Wolf, R.M., Caldwell, J.W., Kollman, P.A., Case, D.A.</span>
<span class="sd">               &quot;Development and testing of a general AMBER force field&quot; (2004)</span>
<span class="sd">               J. Comput. Chem. 25, 1157-1174</span>

<span class="sd">        If using the &#39;Ghemical&#39; force field please cite the following:</span>
<span class="sd">        .. [3] T. Hassinen and M. Perakyla, &quot;New energy terms for reduced </span>
<span class="sd">               protein models implemented in an off-lattice force field&quot; (2001)</span>
<span class="sd">               J. Comput. Chem. 22, 1229-1242</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">openbabel</span> <span class="o">=</span> <span class="n">import_</span><span class="p">(</span><span class="s1">&#39;openbabel&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span><span class="o">.</span><span class="n">get_by_symbol</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s2">&quot;Element name </span><span class="si">{}</span><span class="s2"> not recognized. Cannot &quot;</span>
                                  <span class="s2">&quot;perform minimization.&quot;</span>
                                  <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">particle</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">None</span>

        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kick</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span><span class="s1">&#39;un-minimized.mol2&#39;</span><span class="p">))</span>
        <span class="n">obConversion</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBConversion</span><span class="p">()</span>
        <span class="n">obConversion</span><span class="o">.</span><span class="n">SetInAndOutFormats</span><span class="p">(</span><span class="s2">&quot;mol2&quot;</span><span class="p">,</span> <span class="s2">&quot;mol2&quot;</span><span class="p">)</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBMol</span><span class="p">()</span>

        <span class="n">obConversion</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;un-minimized.mol2&quot;</span><span class="p">))</span>

        <span class="n">ff</span> <span class="o">=</span> <span class="n">openbabel</span><span class="o">.</span><span class="n">OBForceField</span><span class="o">.</span><span class="n">FindForceField</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s2">&quot;Force field &#39;</span><span class="si">{}</span><span class="s2">&#39; not supported for energy &quot;</span>
                              <span class="s2">&quot;minimization. Valid force fields are &#39;MMFF94&#39;, &quot;</span>
                              <span class="s2">&quot;&#39;MMFF94s&#39;, &#39;UFF&#39;, &#39;GAFF&#39;, and &#39;Ghemical&#39;.&quot;</span>
                              <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">forcefield</span><span class="p">))</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Performing energy minimization using the Open Babel package. Please &quot;</span>
             <span class="s2">&quot;refer to the documentation to find the appropriate citations for &quot;</span>
             <span class="s2">&quot;Open Babel and the </span><span class="si">{}</span><span class="s2"> force field&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">forcefield</span><span class="p">))</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;steep&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">SteepestDescent</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;md&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">MolecularDynamicsTakeNSteps</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">ConjugateGradients</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s2">&quot;Invalid minimization algorithm. Valid options &quot;</span>
                              <span class="s2">&quot;are &#39;steep&#39;, &#39;cg&#39;, and &#39;md&#39;.&quot;</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">UpdateCoordinates</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>

        <span class="n">obConversion</span><span class="o">.</span><span class="n">WriteFile</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;minimized.mol2&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_coordinates</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;minimized.mol2&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Compound.save"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">show_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forcefield_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">forcefield_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the Compound to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Filesystem path in which to save the trajectory. The extension or</span>
<span class="sd">            prefix will be parsed and control the format. Supported</span>
<span class="sd">            extensions are: &#39;hoomdxml&#39;, &#39;gsd&#39;, &#39;gro&#39;, &#39;top&#39;, &#39;lammps&#39;, &#39;lmp&#39;</span>
<span class="sd">        show_ports : bool, optional, default=False</span>
<span class="sd">            Save ports contained within the compound.</span>
<span class="sd">        forcefield_name : str, optional, default=None</span>
<span class="sd">            Apply a forcefield to the output file using a forcefield provided</span>
<span class="sd">            by the `foyer` package.</span>
<span class="sd">        forcefield_name : str, optional, default=None</span>
<span class="sd">            Apply a forcefield to the output file using the `foyer` package and</span>
<span class="sd">            a specific forcefield.xml file.</span>
<span class="sd">        box : mb.Box, optional, default=self.boundingbox (with buffer)</span>
<span class="sd">            Box information to be written to the output file. If &#39;None&#39;, a</span>
<span class="sd">            bounding box is used with 0.25nm buffers at each face to avoid</span>
<span class="sd">            overlapping atoms.</span>
<span class="sd">        overwrite : bool, optional, default=False</span>
<span class="sd">            Overwrite if the filename already exists</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        ref_distance : float, optional, default=1.0</span>
<span class="sd">            Normalization factor used when saving to .gsd and .hoomdxml formats</span>
<span class="sd">            for converting distance values to reduced units.</span>
<span class="sd">        ref_energy : float, optional, default=1.0</span>
<span class="sd">            Normalization factor used when saving to .gsd and .hoomdxml formats</span>
<span class="sd">            for converting energy values to reduced units.</span>
<span class="sd">        ref_mass : float, optional, default=1.0</span>
<span class="sd">            Normalization factor used when saving to .gsd and .hoomdxml formats</span>
<span class="sd">            for converting mass values to reduced units.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        formats.gsdwrite.write_gsd : Write to GSD format</span>
<span class="sd">        formats.hoomdxml.write_hoomdxml : Write to Hoomd XML format</span>
<span class="sd">        formats.lammpsdata.write_lammpsdata : Write to LAMMPS data format</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.xyz&#39;</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_trajectory</span><span class="p">(</span><span class="n">show_ports</span><span class="o">=</span><span class="n">show_ports</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Savers supported by mbuild.formats</span>
        <span class="n">savers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.hoomdxml&#39;</span><span class="p">:</span> <span class="n">write_hoomdxml</span><span class="p">,</span>
                  <span class="s1">&#39;.gsd&#39;</span><span class="p">:</span> <span class="n">write_gsd</span><span class="p">,</span>
                  <span class="s1">&#39;.lammps&#39;</span><span class="p">:</span> <span class="n">write_lammpsdata</span><span class="p">,</span>
                  <span class="s1">&#39;.lmp&#39;</span><span class="p">:</span> <span class="n">write_lammpsdata</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">saver</span> <span class="o">=</span> <span class="n">savers</span><span class="p">[</span><span class="n">extension</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">saver</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> exists; not overwriting&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_parmed</span><span class="p">(</span><span class="n">residues</span><span class="o">=</span><span class="n">residues</span><span class="p">)</span>

        <span class="c1"># Apply a force field with foyer if specified</span>
        <span class="k">if</span> <span class="n">forcefield_name</span> <span class="ow">or</span> <span class="n">forcefield_files</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">foyer</span> <span class="k">import</span> <span class="n">Forcefield</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">Forcefield</span><span class="p">(</span><span class="n">forcefield_files</span><span class="o">=</span><span class="n">forcefield_files</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">forcefield_name</span><span class="p">)</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span>
            <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">maxs</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">maxs</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">mins</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.25</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span>

        <span class="c1"># Provide a warning if rigid_ids are not sequential from 0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains_rigid</span><span class="p">:</span>
            <span class="n">unique_rigid_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">rigid_id</span> 
                                           <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rigid_particles</span><span class="p">()]))</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_rigid_ids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unique rigid body IDs are not sequential starting from zero.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">saver</span><span class="p">:</span>  <span class="c1"># mBuild supported saver.</span>
            <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.hoomdxml&#39;</span><span class="p">]:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rigid_bodies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">rigid_id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()]</span>
            <span class="n">saver</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ParmEd supported saver.</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compound.translate"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translate the Compound by a vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        by : np.ndarray, shape=(3,), dtype=float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_positions</span> <span class="o">=</span> <span class="n">_translate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_with_ports</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz_with_ports</span> <span class="o">=</span> <span class="n">new_positions</span></div>

<div class="viewcode-block" id="Compound.translate_to"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.translate_to">[docs]</a>    <span class="k">def</span> <span class="nf">translate_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translate the Compound to a specific position</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos : np.ndarray, shape=3(,), dtype=float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span></div>

<div class="viewcode-block" id="Compound.rotate"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">around</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate Compound around an arbitrary vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            The angle by which to rotate the Compound, in radians.</span>
<span class="sd">        around : np.ndarray, shape=(3,), dtype=float</span>
<span class="sd">            The vector about which to rotate the Compound.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_positions</span> <span class="o">=</span> <span class="n">_rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_with_ports</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">around</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz_with_ports</span> <span class="o">=</span> <span class="n">new_positions</span></div>

<div class="viewcode-block" id="Compound.spin"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.spin">[docs]</a>    <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">around</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate Compound in place around an arbitrary vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : float</span>
<span class="sd">            The angle by which to rotate the Compound, in radians.</span>
<span class="sd">        around : np.ndarray, shape=(3,), dtype=float</span>
<span class="sd">            The axis about which to spin the Compound.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">around</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">around</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">center_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">center_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">around</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">center_pos</span><span class="p">)</span></div>

    <span class="c1"># Interface to Trajectory for reading/writing .pdb and .mol2 files.</span>
    <span class="c1"># -----------------------------------------------------------------</span>
<div class="viewcode-block" id="Compound.from_trajectory"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.from_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">from_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">frame</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract atoms and bonds from a md.Trajectory.</span>

<span class="sd">        Will create sub-compounds for every chain if there is more than one</span>
<span class="sd">        and sub-sub-compounds for every residue.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traj : mdtraj.Trajectory</span>
<span class="sd">            The trajectory to load.</span>
<span class="sd">        frame : int, optional, default=-1 (last)</span>
<span class="sd">            The frame to take coordinates from.</span>
<span class="sd">        coords_only : bool, optional, default=False</span>
<span class="sd">            Only read coordinate information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coords_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traj</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of atoms in </span><span class="si">{traj}</span><span class="s1"> does not match&#39;</span>
                                 <span class="s1">&#39; </span><span class="si">{self}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
            <span class="n">atoms_particles</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">mdtraj_atom</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">atoms_particles</span><span class="p">:</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">frame</span><span class="p">,</span> <span class="n">mdtraj_atom</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="n">atom_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">n_chains</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chain_compound</span> <span class="o">=</span> <span class="n">Compound</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain_compound</span><span class="p">,</span> <span class="s1">&#39;chain[$]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chain_compound</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                    <span class="n">new_atom</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">frame</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
                    <span class="n">chain_compound</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_atom</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">[$]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_atom</span>

        <span class="k">for</span> <span class="n">mdtraj_atom1</span><span class="p">,</span> <span class="n">mdtraj_atom2</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">mdtraj_atom1</span><span class="p">]</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">mdtraj_atom2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_bond</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">unitcell_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></div>

<div class="viewcode-block" id="Compound.to_trajectory"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.to_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">to_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">residues</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert to an md.Trajectory and flatten the compound.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_ports : bool, optional, default=False</span>
<span class="sd">            Include all port atoms when converting to trajectory.</span>
<span class="sd">        chains : mb.Compound or list of mb.Compound</span>
<span class="sd">            Chain types to add to the topology</span>
<span class="sd">        residues : mb.Compound or list of mb.Compound</span>
<span class="sd">            Residue types to add to the topology</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        trajectory : md.Trajectory</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        _to_topology</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">atom_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">particle</span> <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">(</span><span class="n">show_ports</span><span class="p">)]</span>

        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_topology</span><span class="p">(</span><span class="n">atom_list</span><span class="p">,</span> <span class="n">chains</span><span class="p">,</span> <span class="n">residues</span><span class="p">)</span>

        <span class="c1"># Coordinates.</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_list</span><span class="p">):</span>
            <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span>

        <span class="c1"># Unitcell information.</span>
        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span>
        <span class="n">unitcell_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unitcell_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">md</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="o">=</span><span class="n">unitcell_lengths</span><span class="p">,</span>
                             <span class="n">unitcell_angles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">]))</span></div>

    <span class="k">def</span> <span class="nf">_to_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_list</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a mdtraj.Topology from a Compound.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom_list : list of mb.Compound</span>
<span class="sd">            Atoms to include in the topology</span>
<span class="sd">        chains : mb.Compound or list of mb.Compound</span>
<span class="sd">            Chain types to add to the topology</span>
<span class="sd">        residues : mb.Compound or list of mb.Compound</span>
<span class="sd">            Residue types to add to the topology</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        top : mdtraj.Topology</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        mdtraj.Topology : Details on the mdtraj Topology object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mdtraj.core.element</span> <span class="k">import</span> <span class="n">get_by_symbol</span>
        <span class="kn">from</span> <span class="nn">mdtraj.core.topology</span> <span class="k">import</span> <span class="n">Topology</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="p">[</span><span class="n">chains</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chains</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="n">chains</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chains</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">residues</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">Topology</span><span class="p">()</span>
        <span class="n">atom_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">default_chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_chain</span><span class="p">()</span>
        <span class="n">default_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span> <span class="n">default_chain</span><span class="p">)</span>

        <span class="n">compound_residue_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">atom_residue_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">compound_chain_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">atom_chain_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atom_list</span><span class="p">:</span>
            <span class="c1"># Chains</span>
            <span class="k">if</span> <span class="n">chains</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                    <span class="n">current_chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_chain</span><span class="p">()</span>
                    <span class="n">compound_chain_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_chain</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">chains</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compound_chain_map</span><span class="p">:</span>
                                <span class="n">current_chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_chain</span><span class="p">()</span>
                                <span class="n">compound_chain_map</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_chain</span>
                                <span class="n">current_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span> <span class="n">current_chain</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_chain</span> <span class="o">=</span> <span class="n">default_chain</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_chain</span> <span class="o">=</span> <span class="n">default_chain</span>
            <span class="n">atom_chain_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_chain</span>

            <span class="c1"># Residues</span>
            <span class="k">if</span> <span class="n">residues</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                    <span class="n">current_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">current_chain</span><span class="p">)</span>
                    <span class="n">compound_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">residues</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compound_residue_map</span><span class="p">:</span>
                                <span class="n">current_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">current_chain</span><span class="p">)</span>
                                <span class="n">compound_residue_map</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_residue</span> <span class="o">=</span> <span class="n">default_residue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">chains</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="c1"># Grab the default residue from the custom chain.</span>
                        <span class="n">current_residue</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">current_chain</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="c1"># Add the residue to the current chain</span>
                        <span class="n">current_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_residue</span><span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">,</span> <span class="n">current_chain</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># Grab the default chain&#39;s default residue</span>
                    <span class="n">current_residue</span> <span class="o">=</span> <span class="n">default_residue</span>
            <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>

            <span class="c1"># Add the actual atoms</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">get_by_symbol</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">get_by_symbol</span><span class="p">(</span><span class="s2">&quot;VS&quot;</span><span class="p">)</span>
            <span class="n">at</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>
            <span class="n">at</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">charge</span>
            <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">at</span>

        <span class="c1"># Remove empty default residues.</span>
        <span class="n">chains_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">chains</span> <span class="k">if</span> <span class="n">chain</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">residues_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">residues</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains_to_remove</span><span class="p">:</span>
            <span class="n">top</span><span class="o">.</span><span class="n">_chains</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">residues_to_remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chain</span><span class="o">.</span><span class="n">_residues</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Already gone.</span>
                    <span class="k">pass</span>

        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="c1"># Ensure that both atoms are part of the compound. This becomes an</span>
            <span class="c1"># issue if you try to convert a sub-compound to a topology which is</span>
            <span class="c1"># bonded to a different subcompound.</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">atom_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">]):</span>
                <span class="n">top</span><span class="o">.</span><span class="n">add_bond</span><span class="p">(</span><span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom1</span><span class="p">],</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">top</span>

<div class="viewcode-block" id="Compound.from_parmed"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.from_parmed">[docs]</a>    <span class="k">def</span> <span class="nf">from_parmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">coords_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract atoms and bonds from a pmd.Structure.</span>

<span class="sd">        Will create sub-compounds for every chain if there is more than one</span>
<span class="sd">        and sub-sub-compounds for every residue.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        structure : pmd.Structure</span>
<span class="sd">            The structure to load.</span>
<span class="sd">        coords_only : bool</span>
<span class="sd">            Set preexisting atoms in compound to coordinates given by structure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coords_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of atoms in </span><span class="si">{structure}</span><span class="s1"> does not match&#39;</span>
                                 <span class="s1">&#39; </span><span class="si">{self}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
            <span class="n">atoms_particles</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_particles</span><span class="p">(</span><span class="n">include_ports</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">parmed_atom</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">atoms_particles</span><span class="p">:</span>
                <span class="n">particle</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">parmed_atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="n">atom_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">chain_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="n">chains</span><span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residue</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chain</span><span class="p">,</span> <span class="n">residues</span> <span class="ow">in</span> <span class="n">chains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chain_compound</span> <span class="o">=</span> <span class="n">Compound</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chain_compound</span><span class="p">,</span> <span class="n">chain_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chain_compound</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                    <span class="n">new_atom</span> <span class="o">=</span> <span class="n">Particle</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">pos</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">chain_compound</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_atom</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">[$]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_atom</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added&#39;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">residue</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">]</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_bond</span><span class="p">((</span><span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">structure</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></div>

<div class="viewcode-block" id="Compound.to_parmed"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.to_parmed">[docs]</a>    <span class="k">def</span> <span class="nf">to_parmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a ParmEd Structure from a Compound.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        title : str, optional, default=self.name</span>
<span class="sd">            Title/name of the ParmEd Structure</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parmed.structure.Structure</span>
<span class="sd">            ParmEd Structure object converted from self</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        parmed.structure.Structure : Details on the ParmEd Structure object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Structure</span><span class="p">()</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">atom_mapping</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For creating bonds below</span>
        <span class="n">guessed_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">residues</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span>

        <span class="n">default_residue</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Residue</span><span class="p">(</span><span class="s1">&#39;RES&#39;</span><span class="p">)</span>
        <span class="n">compound_residue_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">atom_residue_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">residues</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                <span class="n">current_residue</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Residue</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
                <span class="n">compound_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
            <span class="k">elif</span> <span class="n">residues</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">residues</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compound_residue_map</span><span class="p">:</span>
                            <span class="n">current_residue</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Residue</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">compound_residue_map</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
                        <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Did not find specified residues in ancestors.</span>
                    <span class="n">current_residue</span> <span class="o">=</span> <span class="n">default_residue</span>
                    <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_residue</span> <span class="o">=</span> <span class="n">default_residue</span>
                <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_residue</span>

            <span class="k">if</span> <span class="n">current_residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                <span class="n">structure</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_residue</span><span class="p">)</span>

            <span class="n">atomic_number</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">element_by_name</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guessed_elements</span><span class="p">:</span>
                    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Guessing that &quot;</span><span class="si">{}</span><span class="s1">&quot; is element: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">element</span><span class="p">))</span>
                    <span class="n">guessed_elements</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span>

            <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">atomic_number</span> <span class="ow">or</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
            <span class="n">pmd_atom</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>
            <span class="n">pmd_atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">pmd_atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">pmd_atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Angstroms</span>

            <span class="n">residue</span> <span class="o">=</span> <span class="n">atom_residue_map</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">pmd_atom</span><span class="p">,</span> <span class="n">resname</span><span class="o">=</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">resnum</span><span class="o">=</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>

            <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmd_atom</span>

        <span class="n">structure</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="n">pmd</span><span class="o">.</span><span class="n">Bond</span><span class="p">(</span><span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom1</span><span class="p">],</span> <span class="n">atom_mapping</span><span class="p">[</span><span class="n">atom2</span><span class="p">])</span>
            <span class="n">structure</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>

        <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundingbox</span>
        <span class="n">box_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">box_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.0</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">box_vector</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box_vector</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">box_vector</span>
        <span class="k">return</span> <span class="n">structure</span></div>

<div class="viewcode-block" id="Compound.to_intermol"><a class="viewcode-back" href="../../data_structures.html#mbuild.compound.Compound.to_intermol">[docs]</a>    <span class="k">def</span> <span class="nf">to_intermol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_types</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an InterMol system from a Compound.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule_types : list or tuple of subclasses of Compound</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        intermol_system : intermol.system.System</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">intermol.atom</span> <span class="k">import</span> <span class="n">Atom</span> <span class="k">as</span> <span class="n">InterMolAtom</span>
        <span class="kn">from</span> <span class="nn">intermol.molecule</span> <span class="k">import</span> <span class="n">Molecule</span>
        <span class="kn">from</span> <span class="nn">intermol.system</span> <span class="k">import</span> <span class="n">System</span>
        <span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="k">as</span> <span class="nn">u</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">molecule_types</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">molecule_types</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">molecule_types</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">molecule_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">molecule_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),)</span>
        <span class="n">intermol_system</span> <span class="o">=</span> <span class="n">System</span><span class="p">()</span>

        <span class="n">last_molecule_compound</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">atom_index</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                <span class="c1"># Don&#39;t want inheritance via isinstance().</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">in</span> <span class="n">molecule_types</span><span class="p">:</span>
                    <span class="c1"># Check if we have encountered this molecule type before.</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">intermol_system</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_intermol_molecule_type</span><span class="p">(</span><span class="n">intermol_system</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">last_molecule_compound</span><span class="p">:</span>
                        <span class="n">last_molecule_compound</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="n">last_molecule</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">intermol_system</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="n">last_molecule</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Should never happen if molecule_types only contains type(self)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found an atom </span><span class="si">{}</span><span class="s1"> that is not part of any of &#39;</span>
                                 <span class="s1">&#39;the specified molecule types </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">molecule_types</span><span class="p">))</span>

            <span class="c1"># Add the actual intermol atoms.</span>
            <span class="n">intermol_atom</span> <span class="o">=</span> <span class="n">InterMolAtom</span><span class="p">(</span><span class="n">atom_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">residue_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">residue_name</span><span class="o">=</span><span class="s1">&#39;RES&#39;</span><span class="p">)</span>
            <span class="n">intermol_atom</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">pos</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nanometers</span>
            <span class="n">last_molecule</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">intermol_atom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intermol_system</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_intermol_molecule_type</span><span class="p">(</span><span class="n">intermol_system</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a molecule type for the parent and add bonds. &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">intermol.moleculetype</span> <span class="k">import</span> <span class="n">MoleculeType</span>
        <span class="kn">from</span> <span class="nn">intermol.forces.bond</span> <span class="k">import</span> <span class="n">Bond</span> <span class="k">as</span> <span class="n">InterMolBond</span>

        <span class="n">molecule_type</span> <span class="o">=</span> <span class="n">MoleculeType</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">intermol_system</span><span class="o">.</span><span class="n">add_molecule_type</span><span class="p">(</span><span class="n">molecule_type</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent_atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">particles</span><span class="p">()):</span>
            <span class="n">parent_atom</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="n">intermol_bond</span> <span class="o">=</span> <span class="n">InterMolBond</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">molecule_type</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">intermol_bond</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">())[</span><span class="n">selection</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
        <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> particles, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">):</span>
                <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;periodicity: </span><span class="si">{}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;non-periodic, &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pos=(</span><span class="si">{: .4f}</span><span class="s1">,</span><span class="si">{: .4f}</span><span class="s1">,</span><span class="si">{: .4f}</span><span class="s1">), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> bonds, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bonds</span><span class="p">))</span>

        <span class="n">descr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;id: </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">descr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clone_of</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_container</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A faster alternative to deepcopying.</span>

<span class="sd">        Does not resolve circular dependencies. This should be safe provided</span>
<span class="sd">        you never try to add the top of a Compound hierarchy to a</span>
<span class="sd">        sub-Compound. Clones compound hierarchy only, not the bonds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">root_container</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">root_container</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">clone_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clone_of</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># If this compound has already been cloned, return that.</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">clone_of</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clone_of</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="c1"># Otherwise we make a new clone.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">newone</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># Remember that we&#39;re cloning the new one of self.</span>
        <span class="n">clone_of</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">newone</span>

        <span class="n">newone</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodicity</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">_pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pos</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">port_particle</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_particle</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_if_contains_rigid_bodies</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">_contains_rigid</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contains_rigid</span><span class="p">)</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">_rigid_id</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rigid_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">):</span>
            <span class="n">newone</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newone</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newone</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="c1"># Parent should be None initially.</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">referrers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">newone</span><span class="o">.</span><span class="n">bond_graph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Add children to clone.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">newchild</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">clone_of</span><span class="p">,</span> <span class="n">root_container</span><span class="p">)</span>
                <span class="n">newone</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newchild</span><span class="p">)</span>
                <span class="n">newchild</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">newone</span>

        <span class="c1"># Copy labels, except bonds with atoms outside the hierarchy.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">compound</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compound</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">newone</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">compound</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">clone_of</span><span class="p">,</span> <span class="n">root_container</span><span class="p">)</span>
                    <span class="n">compound</span><span class="o">.</span><span class="n">referrers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clone_of</span><span class="p">[</span><span class="n">compound</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># compound is a list of compounds, so we create an empty</span>
                    <span class="c1"># list, and add the clones of the original list elements.</span>
                    <span class="n">newone</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">subpart</span> <span class="ow">in</span> <span class="n">compound</span><span class="p">:</span>
                        <span class="n">newone</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subpart</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">clone_of</span><span class="p">,</span> <span class="n">root_container</span><span class="p">))</span>
                        <span class="c1"># Referrers must have been handled already, or the will be handled</span>

        <span class="k">return</span> <span class="n">newone</span>

    <span class="k">def</span> <span class="nf">_clone_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clone_of</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">newone</span> <span class="o">=</span> <span class="n">clone_of</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newone</span><span class="o">.</span><span class="n">add_bond</span><span class="p">((</span><span class="n">clone_of</span><span class="p">[</span><span class="n">c1</span><span class="p">],</span> <span class="n">clone_of</span><span class="p">[</span><span class="n">c2</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MBuildError</span><span class="p">(</span><span class="s2">&quot;Cloning failed. Compound contains bonds to &quot;</span>
                                  <span class="s2">&quot;Particles outside of its containment hierarchy.&quot;</span><span class="p">)</span></div>


<span class="n">Particle</span> <span class="o">=</span> <span class="n">Compound</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2017, Vanderbilt University.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>